<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <PropertyGroup>
        <MTP_AssembliesPath>$(MSBuildProjectDirectory)\$(BaseIntermediateOutputPath)\MakeTypesPublic\Assemblies\</MTP_AssembliesPath>
        <MTP_SourcesPath>$(MSBuildProjectDirectory)\$(BaseIntermediateOutputPath)\MakeTypesPublic\Sources\</MTP_SourcesPath>
    </PropertyGroup>

    <UsingTask TaskName="MakeTypesPublic.Tasks.PrintInfoTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />
    <UsingTask TaskName="MakeTypesPublic.Tasks.MakeAssemblyWithPublicTypesTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />
    <UsingTask TaskName="MakeTypesPublic.Tasks.MakeAssemblyInfoTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />

    <!--Print info-->
    <Target Name="MTP_PrintInfo">
        <PrintInfoTask Directory="$(MSBuildThisFileDirectory)" />
    </Target>

    <!--Make source references-->
    <Target Name="MTP_MakeSourceReferences" Outputs="%(ReferencePath.Identity)" Returns="@(MTP_SourceReferences)">
        <PropertyGroup>
            <Local_NuGetPackageId>%(ReferencePath.NuGetPackageId)</Local_NuGetPackageId>
            <Local_MakeTypesPublic Condition="%(PackageReference.Identity) == $(Local_NuGetPackageId)">%(PackageReference.MakeTypesPublic)</Local_MakeTypesPublic>
        </PropertyGroup>
        <ItemGroup>
            <MTP_SourceReferences Include="%(ReferencePath.Identity)" Condition="%(ReferencePath.MakeTypesPublic) == 'true'" />
            <MTP_SourceReferences Include="%(ReferencePath.Identity)" Condition="$(Local_MakeTypesPublic) == 'true'" />
        </ItemGroup>
    </Target>

    <!--Make assemblies-->
    <Target Name="MTP_MakeAssemblies" Condition="@(MTP_SourceReferences) != ''">
        <MakeAssemblyWithPublicTypesTask Reference="%(MTP_SourceReferences.Identity)" DirectoryToSave="$(MTP_AssembliesPath)" >
            <Output TaskParameter="Output" ItemName="Local_NewReference"/>
        </MakeAssemblyWithPublicTypesTask>
        <ItemGroup>
            <ReferencePath Remove="@(MTP_SourceReferences)" />
            <ReferencePath Include="@(Local_NewReference)" />
        </ItemGroup>
    </Target>

    <!--Make sources-->
    <Target Name="MTP_MakeSources" Condition="@(MTP_SourceReferences) != ''" >
        <MakeAssemblyInfoTask References="@(MTP_SourceReferences)" DirectoryToSave="$(MTP_SourcesPath)" >
            <Output TaskParameter="Output" PropertyName="Local_NewFile"/>
        </MakeAssemblyInfoTask>
        <ItemGroup>
            <Compile Include="$(Local_NewFile)"/>
        </ItemGroup>
    </Target>

    <!--MakeTypesPublic-->
    <Target
        Name="MakeTypesPublic"
        AfterTargets="AfterResolveReferences"
        DependsOnTargets="MTP_PrintInfo; MTP_MakeSourceReferences; MTP_MakeAssemblies; MTP_MakeSources">
    </Target>

</Project>