<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <PropertyGroup>
        <MTP_AssembliesPath>$(MSBuildProjectDirectory)\$(BaseIntermediateOutputPath)\MakeTypesPublic\Assemblies\</MTP_AssembliesPath>
        <MTP_SourcesPath>$(MSBuildProjectDirectory)\$(BaseIntermediateOutputPath)\MakeTypesPublic\Sources\</MTP_SourcesPath>
    </PropertyGroup>

    <UsingTask TaskName="MakeTypesPublic.Tasks.PrintInfoTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />
    <UsingTask TaskName="MakeTypesPublic.Tasks.MakeAssemblyWithPublicTypesTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />
    <UsingTask TaskName="MakeTypesPublic.Tasks.MakeAssemblyInfoTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />

    <!--Print info-->
    <Target Name="MTP_PrintInfo">
        <PrintInfoTask Directory="$(MSBuildThisFileDirectory)" />
    </Target>

    <!--Make source references-->
    <Target Name="MTP_MakeSourceReferences_1" Returns="@(MTP_SourceReferences)">
        <ItemGroup>
            <MTP_SourceReferences Include="@(ReferencePath -> WithMetadataValue( 'MakeTypesPublic', 'true' ))" />
        </ItemGroup>
    </Target>
    <Target Name="MTP_MakeSourceReferences_2" Outputs="%(PackageReference.Identity)" Returns="@(MTP_SourceReferences)">
        <PropertyGroup>
            <Local_NuGetPackageId>%(PackageReference.Identity)</Local_NuGetPackageId>
            <Local_MakeTypesPublic>%(PackageReference.MakeTypesPublic)</Local_MakeTypesPublic>
        </PropertyGroup>
        <ItemGroup Condition="$(Local_MakeTypesPublic) == 'true'">
            <MTP_SourceReferences Include="@(ReferencePath -> WithMetadataValue( 'NuGetPackageId', $(Local_NuGetPackageId) ))" />
        </ItemGroup>
    </Target>
    <Target Name="MTP_MakeSourceReferences" DependsOnTargets="MTP_MakeSourceReferences_1;MTP_MakeSourceReferences_2" Returns="@(MTP_SourceReferences)">
    </Target>

    <!--Make assemblies-->
    <Target Name="MTP_MakeAssemblies" Condition="@(MTP_SourceReferences) != ''">
        <MakeAssemblyWithPublicTypesTask Reference="%(MTP_SourceReferences.Identity)" DirectoryToSave="$(MTP_AssembliesPath)" >
            <Output TaskParameter="Output" ItemName="Local_NewReference"/>
        </MakeAssemblyWithPublicTypesTask>
        <ItemGroup>
            <ReferencePath Remove="@(MTP_SourceReferences)" />
            <ReferencePath Include="@(Local_NewReference)" />
        </ItemGroup>
    </Target>

    <!--Make sources-->
    <Target Name="MTP_MakeSources" Condition="@(MTP_SourceReferences) != ''" >
        <MakeAssemblyInfoTask References="@(MTP_SourceReferences)" DirectoryToSave="$(MTP_SourcesPath)" >
            <Output TaskParameter="Output" PropertyName="Local_NewFile"/>
        </MakeAssemblyInfoTask>
        <ItemGroup>
            <Compile Include="$(Local_NewFile)"/>
        </ItemGroup>
    </Target>

    <!--MakeTypesPublic-->
    <Target
        Name="MTP_MakeTypesPublic"
        DependsOnTargets="MTP_PrintInfo; MTP_MakeSourceReferences; MTP_MakeAssemblies; MTP_MakeSources"
        AfterTargets="AfterResolveReferences" >
    </Target>

</Project>