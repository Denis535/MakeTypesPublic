<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <PropertyGroup>
        <MTP_AssembliesDirectory>$(MSBuildProjectDirectory)\$(BaseIntermediateOutputPath)\MakeTypesPublic\Assemblies\</MTP_AssembliesDirectory>
        <MTP_SourcesDirectory>$(MSBuildProjectDirectory)\$(BaseIntermediateOutputPath)\MakeTypesPublic\Sources\</MTP_SourcesDirectory>
    </PropertyGroup>

    <UsingTask TaskName="MakeTypesPublic.Tasks.CheckPackageTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />
    <UsingTask TaskName="MakeTypesPublic.Tasks.CreateFakeAssemblyTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />
    <UsingTask TaskName="MakeTypesPublic.Tasks.CreateAssemblyInfoTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />

    <!--Check package-->
    <Target Name="MTP_CheckPackage">
        <CheckPackageTask MSBuildThisFileFullPath="$(MSBuildThisFileFullPath)" />
    </Target>

    <!--Find source references-->
    <Target Name="MTP_FindSourceReferences" DependsOnTargets="MTP_FindSourceReferences_1;MTP_FindSourceReferences_2" Returns="@(MTP_SourceReferences)" />
    <!--Find source references-->
    <Target Name="MTP_FindSourceReferences_1" Returns="@(MTP_SourceReferences)">
        <ItemGroup>
            <MTP_SourceReferences Include="@(ReferencePath -> WithMetadataValue( 'MakeTypesPublic', 'true' ))" />
        </ItemGroup>
    </Target>
    <!--Find source references-->
    <Target Name="MTP_FindSourceReferences_2" Outputs="%(PackageReference.Identity)" Returns="@(MTP_SourceReferences)">
        <PropertyGroup>
            <Local_NuGetPackageId>%(PackageReference.Identity)</Local_NuGetPackageId>
            <Local_MakeTypesPublic>%(PackageReference.MakeTypesPublic)</Local_MakeTypesPublic>
        </PropertyGroup>
        <ItemGroup Condition="$(Local_MakeTypesPublic) == 'true'">
            <MTP_SourceReferences Include="@(ReferencePath -> WithMetadataValue( 'NuGetPackageId', $(Local_NuGetPackageId) ))" />
        </ItemGroup>
    </Target>
    
    <!--Create assemblies-->
    <Target Name="MTP_CreateAssemblies" Condition="@(MTP_SourceReferences) != ''" Returns="@(MTP_NewReferences)">
        <CreateFakeAssemblyTask Reference="@(MTP_SourceReferences)" DirectoryToSave="$(MTP_AssembliesDirectory)" Condition="%(MTP_SourceReferences.Identity) != ''" >
            <Output TaskParameter="Output" ItemName="MTP_NewAssemblies" />
        </CreateFakeAssemblyTask>
    </Target>

    <!--Create sources-->
    <Target Name="MTP_CreateSources" Condition="@(MTP_SourceReferences) != ''" Returns="@(MTP_NewSources)">
        <CreateAssemblyInfoTask References="@(MTP_SourceReferences)" DirectoryToSave="$(MTP_SourcesDirectory)" >
            <Output TaskParameter="Output" PropertyName="MTP_NewSources" />
        </CreateAssemblyInfoTask>
    </Target>

    <!--MakeTypesPublic-->
    <Target
        Name="MTP_MakeTypesPublic"
        DependsOnTargets="MTP_CheckPackage; MTP_FindSourceReferences; MTP_CreateAssemblies; MTP_CreateSources"
        BeforeTargets="FindReferenceAssembliesForReferences">
        <ItemGroup>
            <ReferencePath Remove="@(MTP_SourceReferences)" />
            <ReferencePath Include="@(MTP_NewAssemblies)" />
            <Compile Include="$(MTP_NewSources)" />
        </ItemGroup>
    </Target>

</Project>