<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <UsingTask TaskName="MakeTypesPublic.Tasks.PrintInfoTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />
    <UsingTask TaskName="MakeTypesPublic.Tasks.MakeAssemblyTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />
    <UsingTask TaskName="MakeTypesPublic.Tasks.MakeAssemblyInfoTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />

    <!--Print info-->
    <Target Name="MTP_PrintInfo">
        <PrintInfoTask Directory="$(MSBuildThisFileDirectory)" />
    </Target>

    <!--Init-->
    <Target Name="MTP_Init">
        <PropertyGroup>
            <MTP_AssembliesPath>$(BaseIntermediateOutputPath)\MakeTypesPublic\Assemblies\</MTP_AssembliesPath>
            <MTP_SourcesPath>$(BaseIntermediateOutputPath)\MakeTypesPublic\Sources\</MTP_SourcesPath>
        </PropertyGroup>
    </Target>
    <Target Name="MTP_Init_After" AfterTargets="MTP_Init" Outputs="%(ReferencePath.Identity)">
        <PropertyGroup>
            <TMP_NuGetPackageId>%(ReferencePath.NuGetPackageId)</TMP_NuGetPackageId>
            <TMP_MakeTypesPublic Condition="%(PackageReference.Identity) == $(TMP_NuGetPackageId)">%(PackageReference.MakeTypesPublic)</TMP_MakeTypesPublic>
        </PropertyGroup>
        <ItemGroup>
            <MTP_ReferencePath Include="%(ReferencePath.Identity)" Condition="%(ReferencePath.MakeTypesPublic) == 'true'" />
            <MTP_ReferencePath Include="%(ReferencePath.Identity)" Condition="$(TMP_MakeTypesPublic) == 'true'" />
        </ItemGroup>
    </Target>

    <!--Make assemblies-->
    <Target Name="MTP_MakeAssemblies" Outputs="%(MTP_ReferencePath.Identity)">
        <MakeAssemblyTask Reference="%(MTP_ReferencePath.Identity)" DirectoryToSave="$(MTP_AssembliesPath)" >
            <Output TaskParameter="OldReference" PropertyName="TMP_OldReference" />
            <Output TaskParameter="NewReference" PropertyName="TMP_NewReference" />
        </MakeAssemblyTask>
        <ItemGroup>
            <ReferencePath Remove="$(TMP_OldReference)" />
            <ReferencePath Include="$(TMP_NewReference)" />
        </ItemGroup>
    </Target>

    <!--Make sources-->
    <Target Name="MTP_MakeSources">
        <MakeAssemblyInfoTask References="@(MTP_ReferencePath)" DirectoryToSave="$(MTP_SourcesPath)" />
    </Target>

    <!--MakeTypesPublic-->
    <Target
        Name="MakeTypesPublic"
        AfterTargets="AfterResolveReferences"
        DependsOnTargets="MTP_PrintInfo; MTP_Init; MTP_MakeAssemblies; MTP_MakeSources" />

</Project>