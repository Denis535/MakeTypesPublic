<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" InitialTargets="MTP_CheckPackage">

    <UsingTask TaskName="MakeTypesPublic.Tasks.CheckPackageTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />
    <UsingTask TaskName="MakeTypesPublic.Tasks.CreateFakeAssembliesTask" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MakeTypesPublic.dll" />

    <!--Check package-->
    <Target Name="MTP_CheckPackage">
        <CheckPackageTask MSBuildThisFileFullPath="$(MSBuildThisFileFullPath)" />
    </Target>

    <!--Get source references-->
    <Target
        Name="MTP_GetSourceReferences"
        Returns="@(MTP_SourceReferences)"
        DependsOnTargets="MTP_GetSourceReferences_1;MTP_GetSourceReferences_2"
        AfterTargets="AfterResolveReferences">
    </Target>
    <!--Get source references 1-->
    <Target
        Name="MTP_GetSourceReferences_1"
        Returns="@(MTP_SourceReferences)">
        <ItemGroup>
            <MTP_SourceReferences Include="@(ReferencePath -> WithMetadataValue( 'IgnoreAccessChecks', 'true' ))" />
        </ItemGroup>
    </Target>
    <!--Get source references 2-->
    <Target
        Name="MTP_GetSourceReferences_2"
        Outputs="%(PackageReference.Identity)"
        Returns="@(MTP_SourceReferences)">
        <PropertyGroup>
            <Local_NuGetPackageId>%(PackageReference.Identity)</Local_NuGetPackageId>
            <Local_IgnoreAccessChecks>%(PackageReference.IgnoreAccessChecks)</Local_IgnoreAccessChecks>
        </PropertyGroup>
        <ItemGroup Condition="$(Local_IgnoreAccessChecks) == 'true'">
            <MTP_SourceReferences Include="@(ReferencePath -> WithMetadataValue( 'NuGetPackageId', $(Local_NuGetPackageId) ))" />
        </ItemGroup>
    </Target>

    <!--Get new references-->
    <Target
        Name="MTP_GetNewReferences"
        Returns="@(MTP_NewReferences)"
        AfterTargets="AfterResolveReferences">
        <ItemGroup>
            <MTP_NewReferences Include="@(MTP_SourceReferences -> '$(BaseIntermediateOutputPath)\MakeTypesPublic\Assemblies\%(Filename)%(Extension)')" />
        </ItemGroup>
    </Target>

    <!--Get assembly attributes-->
    <Target
        Name="MTP_GetAssemblyAttributes"
        Returns="@(AssemblyAttribute)"
        AfterTargets="AfterResolveReferences">
        <ItemGroup>
            <AssemblyAttribute Include="System.Runtime.CompilerServices.IgnoresAccessChecksToAttribute" Condition="@(MTP_SourceReferences) != ''">
                <_Parameter1>%(MTP_SourceReferences.Filename)</_Parameter1>
            </AssemblyAttribute>
        </ItemGroup>
    </Target>

    <!--Create fake assemblies-->
    <Target
        Name="MTP_CreateFakeAssemblies"
        AfterTargets="AfterResolveReferences">
        <CreateFakeAssembliesTask SourceReferences="@(MTP_SourceReferences)" NewReferences="@(MTP_NewReferences)" />
    </Target>

    <!--Set new references-->
    <Target
        Name="MTP_SetNewReferences"
        AfterTargets="AfterResolveReferences">
        <ItemGroup>
            <ReferencePath Remove="@(MTP_SourceReferences)" />
            <ReferencePath Include="@(MTP_NewReferences)" />
        </ItemGroup>
    </Target>

</Project>